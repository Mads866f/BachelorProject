@page "/vote/{JoinCode}"
@rendermode InteractiveServer
@using DTO.Models
@using Front.Services.Interface
@using Front.Services.Interface.Elections
@using Front.Components.Voter

<PageTitle>Voting</PageTitle>


<MudContainer MaxWidth="MaxWidth.Medium">
    <MudGrid Justify="Justify.Center" Spacing="6">
        <MudItem xs="12"><MudText Typo="Typo.h2" Align="Align.Center">Vote For Projects</MudText></MudItem>
        <MudItem xs="12"><MudText Typo="Typo.h2" Align="Align.Center">VoterVoter_Id: @JoinCode</MudText></MudItem>
        <MudItem xs = "12"><MudButton ButtonType="ButtonType.Button" OnClick="SubmitVotes">Submit Vote</MudButton></MudItem>
        <MudItem xs="12">
            <MudStack>
                @foreach (var project in _projects)
                {
                    <ProjectVoteBar AddProject ="AddProjectToVotesApproval" RemoveProject="RemoveProjectFromVotes" project="@project"></ProjectVoteBar>
                }
            </MudStack>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public string? JoinCode { get; set; }
    private List<Project> _projects = [];
    [Inject] private IVotersApiService  _votersApiService { get; set; }
    [Inject] private IProjectsApiService _projectsApiService { get; set; }
    [Inject] private IScoresApiService _scoresApiService { get; set; }

    private Dictionary<string, int> _votes = new Dictionary<string, int>();
    
    private async Task GetProjects()
    {
        var voter = await _votersApiService.GetVoter(JoinCode?? "");
        if (voter.ElectionId == Guid.Empty)
        {
            Console.WriteLine("NO VOTER WITH ID:"+ JoinCode);
            return;
        }
        var electionId = voter.ElectionId;
        _projects = await _projectsApiService.GetProjectsWithElectionId(electionId.ToString());
        StateHasChanged();
    }

    protected override Task OnInitializedAsync()
    {
        _ = GetProjects();
        return base.OnInitializedAsync();
    }

    private async void SubmitVotes()
    {
        //COLLECT VOTE LIST AND SUBMIT TO DB
        Console.WriteLine("JOINCODE"+JoinCode);
        await _scoresApiService.UpdateScores(JoinCode?? "", _votes); 
        Console.WriteLine("Submitted Votes");
    }

    public void AddProjectToVotesApproval(Project project)
    {
        
        Console.WriteLine("PROJECT ID TO ADD: "+ project.Id +  " : "+project.Name);
        _votes.Add(project.Id.ToString(),1);
    }

    public void RemoveProjectFromVotes(Project project)
    {
        _votes.Remove(project.Id.ToString());
    }

}